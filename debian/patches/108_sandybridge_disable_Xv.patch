From 66596980133c76e2c1e81a6d76b949fb5cdbd1b1 Mon Sep 17 00:00:00 2001
From: Matthias Hopf <mhopf@suse.de>
Date: Thu, 30 Sep 2010 12:48:11 +0200
Subject: [PATCH] Re-add XVideo option, as XVideo on SandyBridge freezes the chip.

---
 man/intel.man      |    5 +++++
 src/intel_driver.c |    6 +++++-
 2 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/man/intel.man b/man/intel.man
index 31860f2..3f3b6f2 100644
--- a/man/intel.man
+++ b/man/intel.man
@@ -187,6 +187,11 @@ performance.
 .IP
 Default: enabled.
 .TP
+.BI "Option \*qXVideo\*q \*q" boolean \*q
+Enable XVideo support.
+.IP
+Default: Enabled, except on SandyBridge
+.TP
 .BI "Option \*qXvMC\*q \*q" boolean \*q
 Enable XvMC driver. Current support MPEG2 MC on 915/945 and G33 series.
 User should provide absolute path to libIntelXvMC.so in XvMCConfig file.
diff --git a/src/intel_driver.c b/src/intel_driver.c
index 79c850b..487f5f1 100644
--- a/src/intel_driver.c
+++ b/src/intel_driver.c
@@ -107,6 +107,7 @@ typedef enum {
    OPTION_DEBUG_FLUSH_BATCHES,
    OPTION_DEBUG_FLUSH_CACHES,
    OPTION_DEBUG_WAIT,
+   OPTION_XVIDEO,
 } I830Opts;
 
 static OptionInfoRec I830Options[] = {
@@ -125,6 +126,7 @@ static OptionInfoRec I830Options[] = {
    {OPTION_DEBUG_FLUSH_BATCHES, "DebugFlushBatches", OPTV_BOOLEAN, {0}, FALSE},
    {OPTION_DEBUG_FLUSH_CACHES, "DebugFlushCaches", OPTV_BOOLEAN, {0}, FALSE},
    {OPTION_DEBUG_WAIT, "DebugWait", OPTV_BOOLEAN, {0}, FALSE},
+   {OPTION_XVIDEO,      "XVideo",       OPTV_BOOLEAN,   {0},    FALSE},
    {-1,			NULL,		OPTV_NONE,	{0},	FALSE}
 };
 /* *INDENT-ON* */
@@ -883,7 +885,9 @@ I830ScreenInit(int scrnIndex, ScreenPtr screen, int argc, char **argv)
 	 * Set this so that the overlay allocation is factored in when
 	 * appropriate.
 	 */
-	intel->XvEnabled = TRUE;
+	intel->XvEnabled = xf86ReturnOptValBool(intel->Options,
+						OPTION_XVIDEO,
+						!IS_GEN6(intel));
 
 	xf86DrvMsg(scrn->scrnIndex,
 		   intel->pEnt->device->videoRam ? X_CONFIG : X_DEFAULT,
-- 
1.6.0.2

